project:
  name: "clico.global"
  slug: "clico-site"
  domain: "clico.global"
  repository: "github.com/cpx/clico-site"
  production_branch: "main"

build:
  command: "npm run build"
  directory: ".next"
  framework: "Next.js 14"
  node_version: 20
  environment:
    CF_ACCOUNT_ID: "${CF_ACCOUNT_ID}"
    CF_API_TOKEN: "${CF_API_TOKEN}"
    SOCIAL_PROXY_AUTH: "${SOCIAL_PROXY_AUTH}"
  hooks:
    - name: "Wrangler Pages publish"
      command: "wrangler pages publish .next --project clico-site --branch main"
      when: after_build

deploy:
  previews:
    auto_build: true
    branch: "main"
  production:
    domain: "clico.global"
    environment: "production"
  telemetry:
    analytics: true
    logs: true

wrangler:
  manifest: "wrangler.toml"
  commands:
    deploy: "wrangler pages publish .next --project clico-site --branch main --env production"

notes:
  - "Social links on /dev are proxied by Cloudflare Workers when the project needs auth injection."
  - "Secrets stay in Cloudflare Vault; rotate the CF_API_TOKEN after every 90 day window."
  - "Release workflow: 1) Run `./deploy-clico.sh` to stage, commit, and push to main; 2) Cloudflare Pages builds and publishes automatically via the hook and preview URLs appear for the branch; 3) Validate the `/dev` worker proxies before handing off preview tokens and rotate `SOCIAL_PROXY_AUTH` if a key has leaked."
  - "Preview tokens: use the `cf preview` script in `devops/scripts` (or `wrangler pages preview`/`wrangler pages env preview`) to generate short-lived URLs and share them with QA."
